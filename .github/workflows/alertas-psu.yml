# Workflow de Alertas PSU GetNet
# Executa automaticamente lembretes diários e resumos semanais

name: PSU Alerts GetNet

on:
  schedule:
    # Lembrete diário às 17:00 BRT (20:00 UTC) - Segunda a Sexta
    - cron: '0 20 * * 1-5'
    # Resumo semanal - Segunda às 09:00 BRT (12:00 UTC)
    - cron: '0 12 * * 1'
  
  # Permite execução manual pelo GitHub
  workflow_dispatch:
    inputs:
      alert_type:
        description: 'Tipo de alerta'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - test

jobs:
  send-alert:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install openpyxl
      
      - name: Determine alert type
        id: alert-type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.alert_type }}" >> $GITHUB_OUTPUT
          elif [ "$(date +%u)" == "1" ] && [ "$(date +%H)" == "12" ]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
          else
            echo "type=daily" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack Alert
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import json
          import urllib.request
          import os
          from datetime import datetime

          webhook_url = os.environ.get('SLACK_WEBHOOK_URL')
          alert_type = "${{ steps.alert-type.outputs.type }}"

          if alert_type == "daily":
              hoje = datetime.now()
              data_formatada = hoje.strftime('%d/%m/%Y')
              mensagem = f"""
          :calendar: *LEMBRETE DIÁRIO PSU - {data_formatada}*

          :clock6: *Janela de Execução Hoje:*

          :small_blue_diamond: *DEV* (18:00 - 03:00): 2 GMUDs planejadas
          :small_blue_diamond: *HML* (18:00 - 03:00): 3 GMUDs planejadas  
          :small_blue_diamond: *PROD* (22:00 - 05:00): ~5 GMUDs planejadas

          :warning: *Lembretes:*
          • Verificar aprovação do plantonista antes de iniciar
          • Validar acesso aos servidores
          • Atualizar status na planilha após execução

          :rocket: Bom trabalho, equipe!
          """
          elif alert_type == "weekly":
              mensagem = f"""
          :bar_chart: *RESUMO SEMANAL PSU*

          :calendar: Nova semana de atividades PSU GetNet!

          :point_right: *Ações desta semana:*
          • Revisar servidores pendentes
          • Verificar agendamentos da semana
          • Atualizar planilha de controle

          :memo: Consulte a planilha calendario_psu_2026.xlsx para detalhes.
          """
          else:  # test
              mensagem = ":white_check_mark: *Teste de GitHub Actions funcionando!*"

          payload = {
              'text': mensagem,
              'username': 'PSU Bot GetNet',
              'icon_emoji': ':robot_face:'
          }

          data = json.dumps(payload).encode('utf-8')
          req = urllib.request.Request(
              webhook_url, 
              data=data,
              headers={'Content-Type': 'application/json'}
          )
          urllib.request.urlopen(req)
          print(f"✅ Alerta '{alert_type}' enviado com sucesso!")
          EOF
